<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Maxsus Matematik Klaviatura</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.css" />
  <style>
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      background: var(--tg-theme-bg-color, #f9f9f9);
      color: var(--tg-theme-text-color, #000);
      margin: 0;
      overflow-x: hidden;
    }
    #math-field {
      display: inline-block;
      width: 90%;
      min-height: 60px;
      font-size: 24px;
      border: 2px solid var(--tg-theme-button-color, #ccc);
      border-radius: 8px;
      padding: 10px;
      background: var(--tg-theme-secondary-bg-color, #fff);
      cursor: pointer;
      /* Prevent mobile keyboard */
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
      pointer-events: auto;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #math-field.focused {
      border-color: var(--tg-theme-button-color, #3390ec);
      box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.2);
    }
    #math-field * {
      -webkit-user-select: none;
      user-select: none;
      pointer-events: none;
    }
    #math-field textarea,
    #math-field input {
      position: absolute;
      opacity: 0;
      height: 0;
      width: 0;
      pointer-events: none;
    }
    .keyboard {
      margin-top: 20px;
      display: none; /* Hidden by default */
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      animation: slideUp 0.3s ease-out;
    }
    .keyboard.visible {
      display: grid; /* Show when visible class is added */
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .keyboard button {
      font-size: 18px;
      padding: 15px;
      border: none;
      border-radius: 8px;
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
      transition: opacity 0.2s;
      font-weight: bold;
      -webkit-tap-highlight-color: transparent;
    }
    .keyboard button:active {
      opacity: 0.7;
    }
    #input-placeholder {
      color: var(--tg-theme-hint-color, #999);
      font-size: 16px;
      margin-top: 10px;
      font-style: italic;
    }
    #user-info {
      background: var(--tg-theme-secondary-bg-color, #fff);
      border: 2px solid var(--tg-theme-button-color, #3390ec);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: left;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #user-info h3 {
      margin: 0 0 10px 0;
      color: var(--tg-theme-button-color, #3390ec);
      font-size: 18px;
    }
    #user-info .info-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
    }
    #user-info .info-row:last-child {
      border-bottom: none;
    }
    #user-info .info-label {
      font-weight: bold;
      color: var(--tg-theme-text-color, #333);
    }
    #user-info .info-value {
      color: var(--tg-theme-hint-color, #666);
      text-align: right;
    }
  </style>
</head>
<body>
  <div id="user-info">
    <h3>üë§ Foydalanuvchi Ma'lumotlari</h3>
    <div class="info-row">
      <span class="info-label">Ism:</span>
      <span class="info-value" id="user-name">Yuklanmoqda...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Foydalanuvchi nomi:</span>
      <span class="info-value" id="user-username">Yuklanmoqda...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Foydalanuvchi ID:</span>
      <span class="info-value" id="user-id">Yuklanmoqda...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Til:</span>
      <span class="info-value" id="user-language">Yuklanmoqda...</span>
    </div>
  </div>

  <h2>üñ•Ô∏è Maxsus Matematik Klaviatura</h2>
  <div>
    <span id="math-field"></span>
  </div>
  <p id="input-placeholder">üëÜ Yozishni boshlash uchun yuqoriga bosing</p>

  <div class="keyboard" id="custom-keyboard">
    <button data-cmd="7">7</button>
    <button data-cmd="8">8</button>
    <button data-cmd="9">9</button>
    <button data-cmd="+">+</button>
    <button data-cmd="-">‚àí</button>
    <button data-cmd="*">√ó</button>

    <button data-cmd="4">4</button>
    <button data-cmd="5">5</button>
    <button data-cmd="6">6</button>
    <button data-cmd="/">√∑</button>
    <button data-cmd="=">=</button>
    <button data-cmd="<"><</button>

    <button data-cmd="1">1</button>
    <button data-cmd="2">2</button>
    <button data-cmd="3">3</button>
    <button data-cmd=">">></button>
    <button data-fn="power">x^n</button>
    <button data-fn="frac">a/b</button>

    <button data-cmd="0">0</button>
    <button data-cmd=".">.</button>
    <button data-fn="sqrt">‚àö</button>
    <button data-cmd="x">x</button>
    <button data-cmd="y">y</button>
    <button data-cmd="z">z</button>

    <button data-cmd="a">a</button>
    <button data-cmd="b">b</button>
    <button data-cmd="c">c</button>
    <button data-fn="pi">œÄ</button>
    <button data-cmd="e">e</button>
    <button onclick="mathField.keystroke('Backspace')">‚å´</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
  <script>
    // Initialize Telegram Web App
    let tg = window.Telegram.WebApp;

    // Debug: Log Telegram Web App info
    console.log('=== Telegram Web App Initialized ===');
    console.log('Version:', tg.version);
    console.log('Platform:', tg.platform);
    console.log('Is sendData available:', typeof tg.sendData);
    console.log('initDataUnsafe:', tg.initDataUnsafe);
    console.log('====================================');

    tg.expand(); // Expand to full height
    tg.ready(); // Signal that the app is ready

    // Apply Telegram theme colors
    document.body.style.backgroundColor = tg.themeParams.bg_color || '#f9f9f9';
    document.body.style.color = tg.themeParams.text_color || '#000000';

    // Display User Information from Telegram
    function displayUserInfo() {
      const user = tg.initDataUnsafe?.user;

      if (user) {
        // Populate user information
        document.getElementById('user-name').textContent =
          `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'N/A';

        document.getElementById('user-username').textContent =
          user.username ? `@${user.username}` : 'Yo\'q';

        document.getElementById('user-id').textContent = user.id || 'Yo\'q';

        document.getElementById('user-language').textContent =
          user.language_code?.toUpperCase() || 'Yo\'q';
      } else {
        // Fallback for testing outside Telegram
        document.getElementById('user-name').textContent = 'Demo Foydalanuvchi';
        document.getElementById('user-username').textContent = '@demo';
        document.getElementById('user-id').textContent = '123456789';
        document.getElementById('user-language').textContent = 'UZ';
      }
    }

    // Call the function to display user info on load
    displayUserInfo();

    // Initialize MathQuill
    var MQ = MathQuill.getInterface(2);
    var mathFieldSpan = document.getElementById('math-field');
    var customKeyboard = document.getElementById('custom-keyboard');
    var placeholder = document.getElementById('input-placeholder');
    var keyboardVisible = false;

    window.mathField = MQ.MathField(mathFieldSpan, {
      spaceBehavesLikeTab: true,
      substituteTextarea: function() {
        // Replace default textarea with a dummy that won't trigger keyboard
        var dummy = document.createElement('span');
        dummy.style.position = 'absolute';
        dummy.style.opacity = '0';
        dummy.style.height = '0';
        dummy.style.width = '0';
        dummy.style.pointerEvents = 'none';
        return dummy;
      },
      handlers: {
        edit: function() {
          // Custom edit handler
        }
      }
    });

    // Function to show custom keyboard and enable MainButton
    function showKeyboard() {
      if (!keyboardVisible) {
        customKeyboard.classList.add('visible');
        if (placeholder) placeholder.style.display = 'none';
        keyboardVisible = true;

        // Enable Telegram's MainButton
        tg.MainButton.show();

        // Don't actually focus the mathField to prevent keyboard
        // Just show it as active
        mathFieldSpan.classList.add('focused');
      }
    }

    // Prevent any textareas/inputs inside from getting focus
    mathFieldSpan.addEventListener('focusin', function(e) {
      if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
        e.preventDefault();
        e.stopPropagation();
        e.target.blur();
      }
    }, true);

    // Prevent the native keyboard from appearing and show custom keyboard
    mathFieldSpan.addEventListener('touchstart', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showKeyboard();

      // Blur any active input to prevent keyboard
      if (document.activeElement) {
        document.activeElement.blur();
      }
    }, { passive: false });

    mathFieldSpan.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showKeyboard();

      // Blur any active input to prevent keyboard
      if (document.activeElement) {
        document.activeElement.blur();
      }
    });

    mathFieldSpan.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
    }, { passive: false });

    // Disable text selection and context menu
    document.addEventListener('selectstart', function(e) {
      e.preventDefault();
    });

    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // Handle keyboard button clicks
    document.querySelectorAll(".keyboard button").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        let cmd = btn.getAttribute("data-cmd");
        let fn = btn.getAttribute("data-fn");

        if (cmd) {
          mathField.write(cmd);
        } else if (fn === "frac") {
          mathField.cmd("\\frac");
        } else if (fn === "sqrt") {
          mathField.cmd("\\sqrt");
        } else if (fn === "pi") {
          mathField.cmd("\\pi");
        } else if (fn === "power") {
          mathField.cmd("^");
        }

        // Prevent keyboard from appearing
        if (document.activeElement && document.activeElement.blur) {
          document.activeElement.blur();
        }
      });

      // Prevent keyboard on touch
      btn.addEventListener("touchstart", (e) => {
        e.stopPropagation();
      }, { passive: true });
    });

    // Function to handle submission
    function handleSubmit() {
      const latex = mathField.latex(); // Get the LaTeX representation
      const text = mathField.text(); // Get plain text representation

      if (!latex || latex.trim() === '') {
        tg.showAlert('Iltimos, avval matematik ifoda kiriting!');
        return;
      }

      // Show loading state on MainButton
      tg.MainButton.showProgress();

      // Get user information
      const user = tg.initDataUnsafe?.user || {};

      // Prepare comprehensive data payload
      const payload = {
        // Math expression data
        latex: latex,
        text: text,

        // User information
        user: {
          id: user.id,
          first_name: user.first_name,
          last_name: user.last_name,
          username: user.username,
          language_code: user.language_code,
          is_premium: user.is_premium || false
        },

        // Metadata
        timestamp: new Date().toISOString(),
        platform: tg.platform || 'unknown',
        version: tg.version || 'unknown',
        source: tg.initDataUnsafe?.start_param || 'menu_button'
      };

      // Debug: Log the payload
      console.log('Sending payload:', payload);
      console.log('Telegram object:', tg);

      try {
        // Send data back to the bot
        const jsonData = JSON.stringify(payload);
        console.log('JSON data:', jsonData);

        // Check if sendData is available
        if (typeof tg.sendData === 'function') {
          tg.sendData(jsonData);
          console.log('Data sent successfully');
        } else {
          console.error('tg.sendData is not available');
          tg.showAlert('Xatolik: sendData funksiyasi mavjud emas');
          tg.MainButton.hideProgress();
          return;
        }

        // Close the Web App after a small delay to ensure data is sent
        setTimeout(() => {
          tg.close();
        }, 100);
      } catch (error) {
        console.error('Error sending data:', error);
        tg.showAlert('Ma\'lumot yuborishda xatolik: ' + error.message);
        tg.MainButton.hideProgress();
      }
    }

    // Configure and setup Telegram's MainButton
    tg.MainButton.text = "Ifodani Yuborish";
    tg.MainButton.color = tg.themeParams.button_color || "#3390ec";
    tg.MainButton.textColor = tg.themeParams.button_text_color || "#ffffff";

    // Initially hide the MainButton (show it when keyboard appears)
    tg.MainButton.hide();

    // Attach click handler to MainButton
    tg.MainButton.onClick(handleSubmit);
  </script>
</body>
</html>
