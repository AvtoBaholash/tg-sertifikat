<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Matematik Formulalar Muharriri</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- MathLive (modul sifatida) -->
  <script type="module">
    import 'https://unpkg.com/mathlive?module';
  </script>
  <style>
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--tg-theme-bg-color, #f3f6fb);
      color: var(--tg-theme-text-color, #000);
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    #user-info {
      background: var(--tg-theme-secondary-bg-color, #fff);
      border: 2px solid var(--tg-theme-button-color, #0078d7);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: left;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    #user-info h3 {
      margin: 0 0 10px 0;
      color: var(--tg-theme-button-color, #0078d7);
      font-size: 18px;
      text-align: center;
    }
    #user-info .info-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
    }
    #user-info .info-row:last-child {
      border-bottom: none;
    }
    #user-info .info-label {
      font-weight: bold;
      color: var(--tg-theme-text-color, #333);
    }
    #user-info .info-value {
      color: var(--tg-theme-hint-color, #666);
      text-align: right;
    }
    .editor-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .editor-container h2 {
      color: var(--tg-theme-text-color, #000);
      margin-bottom: 15px;
    }
    math-field {
      width: 90%;
      max-width: 800px;
      min-height: 120px;
      font-size: 1.6em;
      border: 2px solid var(--tg-theme-button-color, #0078d7);
      border-radius: 12px;
      padding: 15px;
      background: var(--tg-theme-secondary-bg-color, white);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      display: inline-block;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    math-field::part(placeholder) {
      font-size: 0.5em;
      color: var(--tg-theme-hint-color, #999);
      opacity: 0.65;
    }
    math-field:focus {
      border-color: var(--tg-theme-button-color, #0078d7);
      box-shadow: 0 0 0 3px rgba(0, 120, 215, 0.2);
      outline: none;
    }
    #input-placeholder {
      color: var(--tg-theme-hint-color, #999);
      font-size: 16px;
      margin-top: 10px;
      font-style: italic;
    }
    .keyboard-info {
      text-align: center;
      color: var(--tg-theme-hint-color, #666);
      font-size: 14px;
      margin-top: 10px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      padding: 10px;
      background: var(--tg-theme-secondary-bg-color, #fff);
      border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #eee);
    }
  </style>
</head>
<body>
  <div id="user-info">
    <h3>üë§ Foydalanuvchi Ma'lumotlari</h3>
    <div class="info-row">
      <span class="info-label">Ism:</span>
      <span class="info-value" id="user-name">Yuklanmoqda...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Foydalanuvchi nomi:</span>
      <span class="info-value" id="user-username">Yuklanmoqda...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Foydalanuvchi ID:</span>
      <span class="info-value" id="user-id">Yuklanmoqda...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Til:</span>
      <span class="info-value" id="user-language">Yuklanmoqda...</span>
    </div>
  </div>

  <div class="editor-container">
    <h4>üìê Matematik Formulalar Muharriri</h4>
    <math-field id="mathInput" virtual-keyboard-mode="onfocus" virtual-keyboard-theme="material"
      placeholder="Formulani yozing... (masalan: ‚à´ sin(x) dx)">
    </math-field>
    <p id="input-placeholder">üëÜ Yozishni boshlash uchun yuqoriga bosing</p>
  </div>

  <script>
    // Initialize Telegram Web App
    let tg = window.Telegram.WebApp;

    // Debug: Log Telegram Web App info
    console.log('=== Telegram Web App Initialized ===');
    console.log('Version:', tg.version);
    console.log('Platform:', tg.platform);
    console.log('Is sendData available:', typeof tg.sendData);
    console.log('initDataUnsafe:', tg.initDataUnsafe);
    console.log('====================================');

    tg.expand(); // Expand to full height
    tg.ready(); // Signal that the app is ready

    // Apply Telegram theme colors
    document.body.style.backgroundColor = tg.themeParams.bg_color || '#f3f6fb';
    document.body.style.color = tg.themeParams.text_color || '#000000';

    // Display User Information from Telegram
    function displayUserInfo() {
      console.log('=== Display User Info ===');
      console.log('tg.initDataUnsafe:', tg.initDataUnsafe);
      console.log('tg.initData:', tg.initData);

      const user = tg.initDataUnsafe?.user;
      console.log('user:', user);

      // Get user info - try multiple sources
      const firstName = user?.first_name || tg.initDataUnsafe?.user?.first_name || '';
      const lastName = user?.last_name || tg.initDataUnsafe?.user?.last_name || '';
      const username = user?.username || tg.initDataUnsafe?.user?.username || '';
      const userId = user?.id || tg.initDataUnsafe?.user?.id || '';
      const languageCode = user?.language_code || tg.initDataUnsafe?.user?.language_code || '';

      console.log('Extracted:', {firstName, lastName, username, userId, languageCode});

      // Build full name
      const fullName = `${firstName} ${lastName}`.trim();

      // Populate user information
      document.getElementById('user-name').textContent = fullName || 'Ma\'lumot yo\'q';
      document.getElementById('user-username').textContent = username ? `@${username}` : 'Yo\'q';
      document.getElementById('user-id').textContent = userId || 'Yo\'q';
      document.getElementById('user-language').textContent = languageCode ? languageCode.toUpperCase() : 'Yo\'q';

      console.log('========================');
    }

    // Call the function to display user info on load
    displayUserInfo();

    // Wait for MathLive to be ready
    window.addEventListener('DOMContentLoaded', function() {
      const mathField = document.getElementById('mathInput');
      const placeholder = document.getElementById('input-placeholder');

      // Hide placeholder when math field is focused
      mathField.addEventListener('focus', function() {
        if (placeholder) placeholder.style.display = 'none';
        // Show Telegram's MainButton when user starts editing
        tg.MainButton.show();
      });

      // Show placeholder when math field is empty and blurred
      mathField.addEventListener('blur', function() {
        if (!mathField.value || mathField.value.trim() === '') {
          if (placeholder) placeholder.style.display = 'block';
        }
      });

      // Monitor changes to show MainButton
      mathField.addEventListener('input', function() {
        if (mathField.value && mathField.value.trim() !== '') {
          tg.MainButton.show();
          if (placeholder) placeholder.style.display = 'none';
        }
      });
    });

    // Function to handle submission
    function handleSubmit() {
      const mathField = document.getElementById('mathInput');
      const latex = mathField.value; // Get the LaTeX representation from MathLive

      if (!latex || latex.trim() === '') {
        tg.showAlert('Iltimos, avval matematik ifoda kiriting!');
        return;
      }

      // Show loading state on MainButton
      tg.MainButton.showProgress();

      // Get user information
      const user = tg.initDataUnsafe?.user || {};

      // Prepare comprehensive data payload
      const payload = {
        // Math expression data
        latex: latex,

        // User information
        user: {
          id: user.id,
          first_name: user.first_name,
          last_name: user.last_name,
          username: user.username,
          language_code: user.language_code,
          is_premium: user.is_premium || false
        },

        // Metadata
        timestamp: new Date().toISOString(),
        platform: tg.platform || 'unknown',
        version: tg.version || 'unknown',
        source: tg.initDataUnsafe?.start_param || 'menu_button'
      };

      // Debug: Log the payload
      console.log('Sending payload:', payload);
      console.log('Telegram object:', tg);

      try {
        // Send data back to the bot
        const jsonData = JSON.stringify(payload);
        console.log('JSON data:', jsonData);

        // Check how the app was opened
        const queryId = tg.initDataUnsafe?.query_id;
        console.log('Query ID:', queryId);

        // Check if we have queryId (inline/menu button) or not (keyboard button)
        if (queryId) {
          // Inline/Menu button - has user data but sendData might not work
          console.log('Inline/Menu button detected with query_id:', queryId);

          // Get user information
          const userDisplayName = user.first_name || 'Foydalanuvchi';
          const userUsername = user.username ? `@${user.username}` : '';

          // Create formatted popup message with expression and user info
          const popupMessage =
            `üìä Ifoda:\n` +
            `LaTeX: ${latex}\n\n` +
            `üë§ Foydalanuvchi:\n` +
            `${userDisplayName} ${userUsername}\n\n` +
            `‚è∞ ${new Date().toLocaleString('uz-UZ')}`;

          // Show popup with result
          tg.showPopup({
            title: '‚úÖ Natija',
            message: popupMessage,
            buttons: [{id: 'ok', type: 'default', text: 'OK'}]
          }, function() {
            tg.close();
          });

        } else if (typeof tg.sendData === 'function') {
          // Keyboard button - can use sendData
          console.log('Keyboard button - using sendData()');

          try {
            tg.sendData(jsonData);
            console.log('Data sent successfully!');

            // Close the Web App after a small delay
            setTimeout(() => {
              tg.close();
            }, 100);

          } catch (e) {
            console.error('sendData failed:', e);
            tg.showAlert('Xatolik: Ma\'lumot yuborilmadi');
            tg.MainButton.hideProgress();
          }

        } else {
          console.error('No valid sending method available');
          tg.showAlert('Xatolik: Ma\'lumot yuborish imkoni yo\'q');
          tg.MainButton.hideProgress();
        }

      } catch (error) {
        console.error('Error sending data:', error);
        tg.showAlert('Ma\'lumot yuborishda xatolik: ' + error.message);
        tg.MainButton.hideProgress();
      }
    }

    // Configure and setup Telegram's MainButton
    tg.MainButton.text = "Ifodani Yuborish";
    tg.MainButton.color = tg.themeParams.button_color || "#0078d7";
    tg.MainButton.textColor = tg.themeParams.button_text_color || "#ffffff";

    // Initially hide the MainButton (show it when user starts editing)
    tg.MainButton.hide();

    // Attach click handler to MainButton
    tg.MainButton.onClick(handleSubmit);
  </script>
</body>
</html>
